%% optimize_deltaV_sensitivity.m
% This script finds maneuver dates that minimize total deltaV
% and outputs a sensitivity table for all tested date combinations

clear; clc;

%% -----------------------------
% Base maneuver dates [YYYY MM DD HH MM SS]
datesPlanets_base = [ ...
    2024 10 14 0 0 0;  % Earth departure
    2025 3  1  0 0 0;  % Mars flyby
    2026 12 3  0 0 0;  % Earth flyby
    2030 4  11 0 0 0]; % Jupiter arrival

%% -----------------------------
% Gravitational parameters (km^3/s^2)
Mu_Sun     = 132712000000;
Mu_Earth   = 398600;
Mu_Mars    = 42828.3;
Mu_Jupiter = 126686000;

%% -----------------------------
% Planet radii (km)
R_Earth   = 6378;
R_Mars    = 3389.5;
R_Jupiter = 71490;

%% -----------------------------
% Gravity-assist settings: force light-side flybys
escape = 0; capture = 0; darkSide = -1; lightSide = 1;
GravityAssistBooleanVec = [escape lightSide lightSide lightSide];

%% -----------------------------
% Search parameters
bestDeltaV = Inf;
bestDates = datesPlanets_base;

% Date variation ranges (in days)
d1_range = 0:5:50; % Earth departure
d2_range = 0:5:50; % Mars flyby
d3_range = 0:5:50; % Earth flyby

% Sensitivity storage
results = [];

%% -----------------------------
% Loop over date combinations
for d1 = d1_range
    for d2 = d2_range
        for d3 = d3_range

            % Adjust dates
            datesPlanets = datesPlanets_base;
            datesPlanets(1,3) = datesPlanets(1,3) + d1;
            datesPlanets(2,3) = datesPlanets(2,3) + d2;
            datesPlanets(3,3) = datesPlanets(3,3) + d3;

            %% -----------------------------
            % Start deltaV calculation (original code logic)
            deltaV_total = 0;

            numObjects = 3;
            rObject = zeros(numObjects,3);
            vObject = zeros(numObjects,3);
            velocityHaveRelSun = zeros(numObjects,3);
            velocityWantRelSun = zeros(numObjects-1,3);

            planetId   = [3 4 3 5]; % Earth, Mars, Earth, Jupiter
            planetInd  = [1 2 3 4];

            %% Compute planet positions at encounter dates
            for di = 1:size(datesPlanets,1)
                [~, rBody, vBody, ~] = planet_elements_and_sv( ...
                    Mu_Sun, planetId(di), datesPlanets(di,1), datesPlanets(di,2), ...
                    datesPlanets(di,3), datesPlanets(di,4), datesPlanets(di,5), datesPlanets(di,6));

                rObject(planetInd(di),:) = rBody;
                vObject(planetInd(di),:) = vBody;
            end

            %% Compute conic arcs between encounters (Lambert)
            datetimePlanets = datetime(datesPlanets(:,1), datesPlanets(:,2), datesPlanets(:,3), ...
                                       datesPlanets(:,4), datesPlanets(:,5), datesPlanets(:,6));
            for di = 2:size(datesPlanets,1)
                rprev = rObject(di-1,:);
                rBody = rObject(di,:);
                dT = seconds(datetimePlanets(di) - datetimePlanets(di-1));
                [V1, V2] = lambertCurtis(Mu_Sun, rprev, rBody, dT, 'pro');

                velocityHaveRelSun(di,:) = V2;
                velocityWantRelSun(di-1,:) = V1;
            end

            %% Earth departure deltaV
            vEarthRelSun = vObject(1,:);
            speedSpacecraftRelEarth = norm(velocityWantRelSun(1,:) - vEarthRelSun);
            delta_v1 = sqrt(speedSpacecraftRelEarth^2 + 2*Mu_Earth/(R_Earth+300)) ...
                     - sqrt(Mu_Earth/(R_Earth+300));
            deltaV_total = deltaV_total + delta_v1;

            %% Jupiter capture deltaV
            vJupiterRelSun = vObject(end,:);
            vSpacecraftRelSun = velocityHaveRelSun(end,:);
            vSpacecraftRelJupiter = -vJupiterRelSun + vSpacecraftRelSun;
            speedSpacecraftRelJupiter = norm(vSpacecraftRelJupiter);

            rapoapsisSpacecraftOrbitJupiter = 1200000;
            rperiapsisSpacecraftOrbitJupiter = 232000;
            sma = (rapoapsisSpacecraftOrbitJupiter + rperiapsisSpacecraftOrbitJupiter)/2;

            speedPeri = sqrt(Mu_Jupiter*(2/rperiapsisSpacecraftOrbitJupiter - 1/sma));
            speedApo  = sqrt(Mu_Jupiter*(2/rapoapsisSpacecraftOrbitJupiter - 1/sma));

            v2 = sqrt(speedSpacecraftRelJupiter^2 + 2*Mu_Jupiter/rperiapsisSpacecraftOrbitJupiter) - speedPeri;
            v3 = sqrt(speedSpacecraftRelJupiter^2 + 2*Mu_Jupiter/rapoapsisSpacecraftOrbitJupiter) - speedApo;

            JupiterCaptureDeltaV = min([v2 v3]);
            deltaV_total = deltaV_total + JupiterCaptureDeltaV;

            %% Gravity assist deltaVs (light-side)
            MuID = [0 Mu_Mars Mu_Earth Mu_Jupiter];
            minRP_Vec = [0 300+R_Mars 300+R_Earth];

            for di = 1:length(velocityWantRelSun)
                Mu_Planet = MuID(di);
                if GravityAssistBooleanVec(di) ~= 0
                    rBody = rObject(di,:);
                    velHaveRelSun = velocityHaveRelSun(di,:);
                    velWantRelSun = velocityWantRelSun(di,:);
                    vBody = vObject(di,:);

                    v_inf_plus = velWantRelSun - vBody;
                    v_inf_mag  = norm(v_inf_plus);

                    % Minimum rp
                    flyby_rad_minimumRP = 2*asin( 1/(1 + minRP_Vec(di)*v_inf_mag^2/Mu_Planet) );

                    % Light-side: rotate so deltaV minimized
                    v_inf_minus_OptimalRP = v_inf_mag*(velHaveRelSun - vBody)/norm(velHaveRelSun - vBody);
                    v_need = vBody + v_inf_minus_OptimalRP;

                    delta_v_gravityAssist = norm(velHaveRelSun - v_need);
                    deltaV_total = deltaV_total + delta_v_gravityAssist;
                end
            end

            %% -----------------------------
            % Record sensitivity
            results = [results; d1, d2, d3, deltaV_total];

            % Update best solution
            if deltaV_total < bestDeltaV
                bestDeltaV = deltaV_total;
                bestDates = datesPlanets;
            end
        end
    end
end

%% -----------------------------
% Show results
fprintf('Minimum total Î”V = %.3f km/s\n', bestDeltaV);
disp('Best maneuver dates (YYYY MM DD HH MM SS):');
disp(bestDates);

%% Sensitivity output
disp('Sensitivity table: [d1 d2 d3 deltaV_total]');
disp(results);
